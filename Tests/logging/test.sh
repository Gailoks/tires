#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TESTS_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
TEST_NAME="logging"

source "$TESTS_DIR/common.sh"

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
init_test_env "$TEST_NAME"

HOT="$TEST_ROOT/hot"
COLD="$TEST_ROOT/cold"
LOG_FILE="$TEST_ROOT/tires.log"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° storage.json Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð° Ñ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¼ Ð¿ÑƒÑ‚Ñ‘Ð¼ Ð»Ð¾Ð³Ð¾Ð²
cat > "$TEST_ROOT/storage.json" << EOF
{
    "IterationLimit": 20,
    "LogLevel": "Debug",
    "LogPath": "$LOG_FILE",
    "TemporaryPath": "tmp",
    "Tiers": [
        {"target": 90, "path": "$HOT"},
        {"target": 100, "path": "$COLD"}
    ]
}
EOF

echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
create_file "$COLD/file1.test" 10
create_file "$COLD/file2.test" 20
create_file "$COLD/file3.test" 15

echo "ðŸ“Š Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹:"
find "$TEST_ROOT" -type f -name "*.test" -exec ls -lh {} \;

# Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
if ! run_app "$TEST_ROOT/storage.json"; then
    test_result false "$TEST_NAME"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
success=true

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» Ð»Ð¾Ð³Ð¾Ð² ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if ! assert_file_exists "$LOG_FILE"; then
    echo "âŒ Ð¤Ð°Ð¹Ð» Ð»Ð¾Ð³Ð¾Ð² Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½: $LOG_FILE"
    success=false
fi

# 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð»Ð¾Ð³Ð¾Ð² (timestamp level category: message)
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð»Ð¾Ð³Ð¾Ð²..."
if [[ -f "$LOG_FILE" ]]; then
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð»Ð¾Ð³Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ðµ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹
    # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: 2026-02-24 20:43:33 info ConfigLoader: message
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ timestamp Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
    if ! grep -qE "^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} " "$LOG_FILE"; then
        echo "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ timestamp Ð½Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¼Ñƒ"
        success=false
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (info, debug, warning, error Ñ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð¼ Ð¿Ð¾ÑÐ»Ðµ)
    if ! grep -qE " (information|debug|warning|error) " "$LOG_FILE"; then
        echo "âŒ Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð¸Ð»Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð½ÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹"
        echo "   ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ: (information|debug|warning|error) Ñ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð¼ Ð¿Ð¾ÑÐ»Ðµ"
        success=false
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð½ÐµÑ‚ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ° "Tires." Ð² ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÑ…
    if grep -qE " Tires\." "$LOG_FILE"; then
        echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ 'Tires.' Ð² ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÑ… (Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐ´Ð°Ð»Ñ‘Ð½)"
        success=false
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð² Ð»Ð¾Ð³Ð°Ñ…
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð² Ð»Ð¾Ð³Ð°Ñ…..."
    
    if ! grep -qi "configuration loaded\|config loaded" "$LOG_FILE"; then
        echo "âš ï¸  ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸"
    fi
    
    if ! grep -qi "scan started\|storage scan" "$LOG_FILE"; then
        echo "âš ï¸  ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
    fi
    
    if ! grep -qi "files found\|files:" "$LOG_FILE"; then
        echo "âš ï¸  ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
    fi
    
    if ! grep -qi "moved\|move" "$LOG_FILE"; then
        echo "âš ï¸  ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²"
    fi
    
    # Ð’Ñ‹Ð²Ð¾Ð´ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ Ð»Ð¾Ð³Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
    echo "ðŸ“„ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ„Ð°Ð¹Ð»Ð° Ð»Ð¾Ð³Ð¾Ð²:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    cat "$LOG_FILE"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
fi

# 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð»Ð¾Ð³Ð¸ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ (output.log)
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ..."
if [[ -f "$TEST_ROOT/output.log" ]]; then
    if ! grep -qE "^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} " "$TEST_ROOT/output.log"; then
        echo "âŒ ÐšÐ¾Ð½ÑÐ¾Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ timestamp Ð² Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ"
        success=false
    fi
else
    echo "âš ï¸  Ð¤Ð°Ð¹Ð» output.log Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ (ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½)"
fi

# 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» Ð»Ð¾Ð³Ð¾Ð² Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ (Ð½Ðµ Ð°Ð¿Ð¿ÐµÐ½Ð´Ð¸Ñ‚ÑÑ)
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ¸ Ñ„Ð°Ð¹Ð»Ð° Ð»Ð¾Ð³Ð¾Ð²..."
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ€Ð°Ð·
create_file "$COLD/file4.test" 5
if ! run_app "$TEST_ROOT/storage.json"; then
    test_result false "$TEST_NAME"
fi

if [[ -f "$LOG_FILE" ]]; then
    # Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº Ñ "Started" Ð¸Ð»Ð¸ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹Ð¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»Ð°
    # Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ, Ñ‚Ð°ÐºÐ¾Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 1 Ñ€Ð°Ð·
    start_count=$(grep -ci "scan started\|storage scan started" "$LOG_FILE" || echo "0")
    if [[ "$start_count" -gt 1 ]]; then
        echo "âŒ Ð¤Ð°Ð¹Ð» Ð»Ð¾Ð³Ð¾Ð² Ð½Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ (Ð½Ð°Ð¹Ð´ÐµÐ½ Ð´ÑƒÐ±Ð»ÑŒ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð½Ð°Ñ‡Ð°Ð»Ð°: $start_count Ñ€Ð°Ð·)"
        success=false
    else
        echo "âœ… Ð¤Ð°Ð¹Ð» Ð»Ð¾Ð³Ð¾Ð² Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
    fi
fi

test_result "$success" "$TEST_NAME"
