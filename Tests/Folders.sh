#!/usr/bin/env bash
set -euo pipefail

HOT="/mnt/hot"
COLD="/mnt/cold"

# Очистка
rm -rf "$HOT"/* "$COLD"/* || true
mkdir -p "$HOT" "$COLD"

###########################################
# 1) Генерация вложенной структуры с файлами только на глубоком уровне
###########################################
echo "Создаём вложенные каталоги с файлами на COLD..."

for i in {1..3}; do
    mkdir -p "$COLD/level1_$i/level2_$i/level3_$i"
    # Файл только на самом глубоком уровне
    echo "data $i" > "$COLD/level1_$i/level2_$i/level3_$i/file_$i.txt"
done

###########################################
# 2) Запускаем программу
###########################################
dotnet run >/dev/null

success=true

###########################################
# 3) Проверка: на COLD не должно остаться файлов
###########################################
left_files=$(find "$COLD" -type f | wc -l)
if [[ "$left_files" -gt 0 ]]; then
    echo "❌ FAILED: На COLD остались файлы:"
    find "$COLD" -type f
    success=false
fi

###########################################
# 4) Проверка: все файлы перенесены на HOT с правильной структурой
###########################################
for i in {1..3}; do
    file="$HOT/level1_$i/level2_$i/level3_$i/file_$i.txt"

    if [[ ! -f "$file" ]]; then
        echo "❌ FAILED: Нет файла на глубоком уровне $file"
        success=false
    fi
done

###########################################
# 5) Итог
###########################################
if $success; then
    echo "✅ Все файлы успешно перенесены на HOT"
    exit 0
else
    echo "❌ Провал теста по перемещению файлов"
    exit 1
fi
